<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi Keterlambatan - Emerald Premium</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --soft-red-50:#fdecec;
      --soft-red-100:#f9d5d5;
      --soft-red-300:#e79a9a;
      --soft-red-500:#c75f5f;
      --card-bg:#fff;
      --muted:#6b7280;
    }

    body{
      font-family: "Inter", system-ui;
      background: linear-gradient(180deg,var(--soft-red-50),#fff 40%);
      padding: 28px;
      color:#2b2b2b;
    }

    .brand-title{
      font-size:32px;
      font-weight:800;
      color:var(--soft-red-500);
      text-align:center;
      margin-bottom:4px;
    }
    .subtitle{
      text-align:center;
      color:#777;
      margin-top:-6px;
      margin-bottom:25px;
    }

    .card-premium{
      background:var(--card-bg);
      border-radius:14px;
      border:1px solid rgba(199,95,95,0.15);
      box-shadow:0 8px 26px rgba(0,0,0,0.06);
    }

    .card-form{
      padding:32px !important;
      background:#fff;
      border-left:8px solid var(--soft-red-300);
    }

    .form-label{ font-weight:600; }

    .btn-red{
      background: linear-gradient(90deg,var(--soft-red-300),var(--soft-red-500));
      border:none;
      color:white;
      font-weight:600;
      border-radius:10px;
      padding:10px 16px;
    }

    .btn-outline-red{
      color:var(--soft-red-500);
      border:1px solid rgba(199,95,95,0.3);
      background:rgba(199,95,95,0.05);
      font-weight:600;
      border-radius:10px;
    }

    .btn-dashboard{
      background:linear-gradient(135deg, var(--soft-red-300), var(--soft-red-500));
      border:none;
      color:white;
      font-weight:700;
      padding:14px 20px;
      border-radius:14px;
      width:100%;
      box-shadow:0 6px 16px rgba(199,95,95,0.28);
      transition:0.3s;
    }
    .btn-dashboard:hover{
      transform:translateY(-3px);
      box-shadow:0 10px 22px rgba(199,95,95,0.35);
    }

    .stat-card{
      background:#fff;
      border:1px solid rgba(199,95,95,0.1);
      border-radius:10px;
      padding:14px;
    }

    .custom-header{
      background: var(--soft-red-500);
      color: white;
      padding: 22px 26px;
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
      border-bottom: 3px solid rgba(0,0,0,0.08);
      box-shadow: inset 0 -2px 4px rgba(0,0,0,0.08);
      margin-bottom: 30px;
    }

    .custom-header .header-title{
      margin:0;
      font-weight:700;
      font-size:22px;
      letter-spacing:0.3px;   
    }

    .custom-header .header-subtitle{
      margin:4px 0 0;
      font-size:14px;
      opacity:0.9;
    }
  </style>
</head>
<body>

<div class="container">

  <div class="text-center mb-4">
    <div class="brand-title">ABSENSI KETERLAMBATAN</div>
    <div class="subtitle">Form keterlambatan & Dashboard</div>
  </div>

  <!-- FORM -->
  <div class="card-premium card-form mb-4">
    <div class="card-header custom-header">
      <h4 class="header-title">Form Keterlambatan</h4>
      <p class="header-subtitle">Isi data pegawai yang terlambat. Data akan tersimpan di Database HCC.</p>
    </div>
    <div class="card-body">
      <!-- Form START (pastikan tombol submit berada di dalam form) -->
      <form id="absenForm">
        <div class="mb-3">
          <label class="form-label">Nama Pegawai</label>
          <input id="nama" type="text" class="form-control" required placeholder="Nama Lengkap">
        </div>
        <div class="mb-3">
          <label class="form-label">NPP Pegawai</label>
          <input id="npp" type="text" class="form-control" required placeholder="NPP Pegawai">
        </div>
        <div class="mb-3">
          <label class="form-label">Divisi</label>
          <select id="divisi" class="form-select" required>
            <option value="">-- Pilih Divisi --</option>
            <option>CSI</option><option>FRM</option><option>HCC</option><option>INA</option>
            <option>MBS</option><option>OPS</option><option>OPR-1</option><option>OPR-2</option>
            <option>PLM</option><option>SBD</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Alasan Keterlambatan</label>
          <textarea id="alasan" rows="3" class="form-control" required></textarea>
        </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn-red">Kirim Absensi</button>
          <button id="btnViewDashboard" type="button" class="btn-dashboard">ðŸ“Š Buka Dashboard</button>
        </div>

        <div id="sendInfo" class="mt-3" style="display:none;">
          <small class="hint">Status: <span id="sendStatus" style="font-weight:600"></span></small>
        </div>
      </form>
      <!-- Form END -->
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="card-premium p-3 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <div style="font-weight:700;color:var(--soft-red-500)">Dashboard</div>
        <div class="hint">Grafik & Top 10 Pegawai Terlambat</div>
      </div>
      <button id="refreshBtn" class="btn btn-sm btn-outline-red">Refresh</button>
    </div>

    <div id="dashboardArea">
      <div class="stat-card mb-3">
        <canvas id="chartDivisi" height="220"></canvas>
      </div>

      <div class="mt-3">
        <h6 style="color:var(--soft-red-500); margin-bottom:8px">Top 10 Paling Sering Terlambat</h6>
        <div id="top10Container"></div>
      </div>
    </div>

    <div id="emptyHint" class="text-center text-muted py-4" style="display:none;">
      Belum ada data. Silakan submit beberapa entry lalu klik Refresh.
    </div>
  </div>

</div>

<!-- MODAL (ditambahkan) -->
<div class="modal fade" id="msgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header border-0">
        <h5 class="modal-title" style="color:var(--soft-red-500);">Sukses!</h5>
      </div>
      <div class="modal-body text-center">
        <p>Terima kasih, data Anda telah kami simpan.</p>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-red w-100" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- IMPORTANT: load Bootstrap JS BEFORE the script that calls bootstrap.Modal -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- SCRIPT ASLI (TIDAK DIUBAH) - hanya ditambahkan pemanggil modal setelah Terkirim -->
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxPGZuS11u7MhMufPyJjsWVN6XkLMgt4y7QeZslzNH4A8lkSakdpa7QA5S3bJrwUg/exec";

document.getElementById("absenForm").addEventListener("submit", async (ev) => {
  ev.preventDefault();
  const nama = document.getElementById("nama").value.trim();
  const npp = document.getElementById("npp").value.trim();
  const divisi = document.getElementById("divisi").value;
  const alasan = document.getElementById("alasan").value.trim();
  if (!nama || !npp || !divisi || !alasan) return alert("Lengkapi semua kolom.");

  const url = `${scriptURL}?mode=add&nama=${encodeURIComponent(nama)}&npp=${encodeURIComponent(npp)}&divisi=${encodeURIComponent(divisi)}&alasan=${encodeURIComponent(alasan)}`;

  try {
    document.getElementById("sendInfo").style.display = "block";
    document.getElementById("sendStatus").textContent = "Mengirim...";
    await fetch(url, { method:"GET", cache:"no-cache" });
    document.getElementById("sendStatus").textContent = "Terkirim âœ“";

    // --- tampilkan modal sukses (Bootstrap sudah dimuat sebelumnya)
    if (window.bootstrap && document.getElementById('msgModal')) {
      const modal = new bootstrap.Modal(document.getElementById('msgModal'));
      modal.show();
    }

    setTimeout(()=>{
      document.getElementById("sendStatus").textContent="";
      document.getElementById("sendInfo").style.display="none";
      document.getElementById("absenForm").reset();
    },900);
  } catch(err){
    document.getElementById("sendStatus").textContent="Gagal";
    alert("Gagal mengirim data.");
  }
});

document.getElementById("btnViewDashboard").addEventListener("click", ()=>{
  document.getElementById("dashboardArea").scrollIntoView({ behavior:"smooth" });
  loadDashboard();
});
document.getElementById("refreshBtn").addEventListener("click", loadDashboard);

let chartInstance=null;

async function loadDashboard(){
  try{
    const res = await fetch(`${scriptURL}?mode=grafik`, { cache:"no-cache" });
    const payload = await res.json();

    const divisiData = Array.isArray(payload.divisi)?payload.divisi:[];
    const rankingData = Array.isArray(payload.ranking)?payload.ranking:[];

    if(divisiData.length===0 && rankingData.length===0){
      document.getElementById("dashboardArea").style.display="none";
      document.getElementById("emptyHint").style.display="block";
      return;
    } else{
      document.getElementById("dashboardArea").style.display="block";
      document.getElementById("emptyHint").style.display="none";
    }

    renderChartDivisi(divisiData);
    renderTop10(rankingData);

  } catch(err){
    alert("Gagal memuat dashboard.");
  }
}

function renderChartDivisi(divisiData){
  const labels = divisiData.map(d=>d.divisi);
  const counts = divisiData.map(d=>d.count);

  const ctx = document.getElementById('chartDivisi').getContext('2d');
  if(chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx,{
    type:'bar',
    data:{
      labels:labels,
      datasets:[{
        label:'Jumlah Keterlambatan',
        data:counts,
        backgroundColor:'rgba(199,95,95,0.65)',
        borderColor:'rgba(199,95,95,1)',
        borderWidth:1,
        borderRadius:6
      }]
    }
  });
}

function renderTop10(data){
  let arr = data.slice();
  arr.sort((a,b)=>b.count-a.count);
  arr = arr.slice(0,10);

  let html = `<table class="table table-sm">
    <thead><tr><th>Rank</th><th>Nama</th><th>Frekuensi</th></tr></thead><tbody>`;
  arr.forEach((r,i)=>{
    html+=`<tr>
      <td><span class="badge bg-danger">${i+1}</span></td>
      <td>${r.nama}</td>
      <td>${r.count} kali</td>
    </tr>`;
  });
  html+=`</tbody></table>`;
  document.getElementById("top10Container").innerHTML = html;
}
</script>

</body>
</html>
